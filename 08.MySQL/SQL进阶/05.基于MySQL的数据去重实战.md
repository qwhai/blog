## 基于MySQL的数据去重实战

### 1. 单表去重

#### 1.1 数据设定

假设现有一个数据表：`guid_20190601`<br>
其中包含两个数据字段:`_id`和`guid`

*guid_20190601*
```
+-----+--------------------------------------+
| _id | guid                                 |
+-----+--------------------------------------+
|   1 | afd2e277-5d08-4921-82c7-c558a8f84667 |
|   2 | 3329cdad-dbbc-48ac-b275-44d20f1898ec |
|   3 | afd2e277-5d08-4921-82c7-c558a8f84667 |
+-----+--------------------------------------+
```

#### 1.2 GROUP BY

关于去重问题，第一个想到的可能是`GROUP BY`，就像下面这样：
```sql
SELECT guid FROM `guid_20190601` GROUP BY guid;
```
```
+--------------------------------------+
| guid                                 |
+--------------------------------------+
| 3329cdad-dbbc-48ac-b275-44d20f1898ec |
| afd2e277-5d08-4921-82c7-c558a8f84667 |
+--------------------------------------+
```

#### 1.3 DISTINCT

对于单表，其实还有另一种去重方式，使用`DISTINCT`进行去重操作：
```sql
SELECT DISTINCT guid FROM `guid_20190601`;
```
```
+--------------------------------------+
| guid                                 |
+--------------------------------------+
| afd2e277-5d08-4921-82c7-c558a8f84667 |
| 3329cdad-dbbc-48ac-b275-44d20f1898ec |
+--------------------------------------+
```

从名词释义的角度上来说，`DISTINCT`似乎是专门进行去重操作的。然而站在实际的角度来也是如此。详情见`1.4 EXPLAIN`

#### 1.4 EXPLAIN

*DISTINCT*
```sql
EXPLAIN SELECT DISTINCT guid FROM `guid_20190601`;
```
```
+----+---------------+------+----------+-----------------+
| id | table         | rows | filtered | Extra           |
+----+---------------+------+----------+-----------------+
|  1 | guid_20190601 |    3 |   100.00 | Using temporary |
+----+---------------+------+----------+-----------------+
```

*GROUP BY*
```sql
EXPLAIN SELECT guid FROM `guid_20190601` GROUP BY guid;
```
```
+----+---------------+------+----------+---------------------------------+
| id | table         | rows | filtered | Extra                           |
+----+---------------+------+----------+---------------------------------+
|  1 | guid_20190601 |    3 |   100.00 | Using temporary; Using filesort |
+----+---------------+------+----------+---------------------------------+
```


这里我省去了部分`EXPLAIN`结果一致的数据，数据一致则没有比较的价值（这里只是略去了一部分，也保留了一部分一致的数据，是因为只有一项不一致，只保留一项比较突兀，所以还请不要杠）。

从`EXPLAIN`的结果可以看到在进行`GROUP BY`时，还进行了`Using filesort`处理。当进行大量数据的操作时，无疑是对性能有直接影响的。

### 2. 多表去重

#### 2.1 数据设定

多表的数据设定在单表去重的数据上再加上一个`guid_20190602`和一个`guid_20190603`表。字段与`guid_20190601`保持一致。

*guid_20190602*
```
+-----+--------------------------------------+
| _id | guid                                 |
+-----+--------------------------------------+
|   1 | 3329cdad-dbbc-48ac-b275-44d20f1898ec |
|   2 | 9323714a-35de-47b5-ac1f-80d8e34f6f93 |
|   3 | a9d3bd21-d4ab-4773-a30c-07e3cc947014 |
|   4 | 3329cdad-dbbc-48ac-b275-44d20f1898ec |
+-----+--------------------------------------+
```

*guid_20190603*
```
+-----+--------------------------------------+
| _id | guid                                 |
+-----+--------------------------------------+
|   1 | fe45c80b-2ec7-494a-a7f4-8a707c4f7510 |
|   2 | 84ef7616-9dc1-4469-9a1e-7edfbcbd34df |
|   3 | 5205c8e7-3888-4ae2-b158-85755abb6422 |
|   4 | 9cbd3f26-fcfe-4a4b-b806-1ff911c1e8f1 |
+-----+--------------------------------------+
```

#### 2.2 数据去重

在单表去重中使用了两种方案进行去重。而在多表查询时，`DISTINCT`字段则显得有些力不从心了。<br>
例如，单表查询时我们看到了`DISTINCT`在去重中的优势，在多表查询时，也想引入。就像下面这样：
```sql
SELECT
    DISTINCT guid
FROM
    `guid_20190601`
UNION
SELECT
    DISTINCT guid
FROM
    `guid_20190602`
UNION
SELECT
    DISTINCT guid
FROM
    `guid_20190603`;
```

```
+--------------------------------------+
| guid                                 |
+--------------------------------------+
| afd2e277-5d08-4921-82c7-c558a8f84667 |
| 3329cdad-dbbc-48ac-b275-44d20f1898ec |
| 9323714a-35de-47b5-ac1f-80d8e34f6f93 |
| a9d3bd21-d4ab-4773-a30c-07e3cc947014 |
| fe45c80b-2ec7-494a-a7f4-8a707c4f7510 |
| 84ef7616-9dc1-4469-9a1e-7edfbcbd34df |
| 5205c8e7-3888-4ae2-b158-85755abb6422 |
| 9cbd3f26-fcfe-4a4b-b806-1ff911c1e8f1 |
+--------------------------------------+
```

这里的本意是先在各个单表中去重，完成之后，再合并各已去重的表。想法很好，最终也获得了正确结果，不过我们还是要通过`EXPLAIN`一探究竟。

#### 2.3 EXPLAIN

*引入 DISTINCT*
```sql
EXPLAIN SELECT
    DISTINCT guid
FROM
    `guid_20190601`
UNION
SELECT
    DISTINCT guid
FROM
    `guid_20190602`
UNION
SELECT
    DISTINCT guid
FROM
    `guid_20190603`;
````

```
+------+---------------+------+----------+-----------------+
| id   | table         | rows | filtered | Extra           |
+------+---------------+------+----------+-----------------+
|  1   | guid_20190601 |    3 |   100.00 | Using temporary |
|  2   | guid_20190602 |    4 |   100.00 | Using temporary |
|  3   | guid_20190603 |    4 |   100.00 | Using temporary |
| NULL | <union1,2,3>  | NULL |     NULL | Using temporary |
+------+---------------+------+----------+-----------------+
```

*单纯 UNION*
```sql
EXPLAIN SELECT
    guid
FROM
    `guid_20190601`
UNION
SELECT
    guid
FROM
    `guid_20190602`
UNION
SELECT
    guid
FROM
    `guid_20190603`;
````

```
+------+---------------+------+----------+-----------------+
| id   | table         | rows | filtered | Extra           |
+------+---------------+------+----------+-----------------+
|  1   | guid_20190601 |    3 |   100.00 | NULL            |
|  2   | guid_20190602 |    4 |   100.00 | NULL            |
|  3   | guid_20190603 |    4 |   100.00 | NULL            |
| NULL | <union1,2,3>  | NULL |     NULL | Using temporary |
+------+---------------+------+----------+-----------------+
```

从`EXPLAIN`的结果可以看出，引入DISTINCT的方案中，第个`guid_2019060x`表都使用了临时表（Using temporary）。所以从空间角度看，多表去重不需要使用`DISTINCT`。

---

作者：Q-WHai<br>
日期：2019年06月03日<br>
Github：[https://github.com/qwhai](https://github.com/qwhai)

---
